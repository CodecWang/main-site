# å¤§ä»“å®è·µå½•ï¼šLerna/NPM/Yarn Workspace æ–¹æ¡ˆç»„åˆå’Œæ€§èƒ½å¯¹æ¯”

- Author: Codec.Wang
- Date: 2020/11/05

## æ¦‚å¿µï¼šå•ä»“å’Œå¤§ä»“

ä»“å°±æ˜¯ä»“åº“ï¼ˆrepositoryï¼Œç®€ç§° repoï¼‰ã€‚é€šå¸¸æˆ‘ä»¬ä½¿ç”¨å¤šä¸ªä»“åº“ï¼ˆç®€ç§°å¤šä»“ï¼Œmulti-repoï¼‰æ¥ç®¡ç†é¡¹ç›®ä»£ç ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªä»“åº“è´Ÿè´£ä¸€ä¸ªæ¨¡å—æˆ–åŒ…çš„ç¼–ç ã€æ„å»ºã€æµ‹è¯•å’Œå‘å¸ƒï¼Œä»£ç è§„æ¨¡ç›¸å¯¹è¾ƒå°ï¼Œæ‰€ä»¥ä¹Ÿç§°ä¸ºå°å‹è§„æ¨¡ä»“åº“ï¼ˆç®€ç§°å°ä»“ï¼‰ã€‚è€Œå•ä¸€ï¼ˆmonoï¼‰ä»“åº“ï¼ˆç®€ç§°å•ä»“ï¼Œmono-repoï¼‰æ˜¯æŒ‡åœ¨ä¸€ä¸ªä»“åº“ä¸­ç®¡ç†å¤šä¸ªæ¨¡å—æˆ–åŒ…ï¼Œå½“ä»£ç è§„æ¨¡è¾¾åˆ°ä¸€å®šç¨‹åº¦åå¯ç§°ä¸ºå¤§å‹è§„æ¨¡ä»“åº“ï¼ˆç®€ç§°å¤§ä»“ï¼‰ï¼Œè‡³äºè¿™ä¸ªç¨‹åº¦å¤§å°å¹¶æ²¡æœ‰æ˜ç¡®å®šä¹‰ï¼Œé€šå¸¸è¯´çš„å¤§ä»“å¯ç†è§£ä¸ºå°±æ˜¯å•ä»“ã€‚

æˆ‘ä»¬ä»¥ä¸€ä¸ªé€šå¸¸çš„ Node JS é¡¹ç›®ä¸ºä¾‹ï¼Œç®€è¦è¯´æ˜è¿™å‡ ç§ä»“åº“ç®¡ç†æ–¹å¼ï¼Œå¦‚ä¸‹å›¾ï¼š

![](https://techblog-1253540739.cos.ap-chengdu.myqcloud.com/monolith-multi-repo-mono-repo.jpg)

> ä¸ºä¾¿äºç†è§£ï¼Œè¿™é‡Œæˆ‘ä»è½¯ä»¶æ¶æ„å±‚é¢å¼•å‡ºå¤§ä»“ï¼Œä½†å…¶å®ä»“åº“ç®¡ç†æ–¹å¼å’Œè½¯ä»¶æ¶æ„å¹¶æ²¡æœ‰ç›´æ¥å…³ç³»ï¼Œå¤§ä»“ä¹Ÿå¹¶é â€œé“¶å¼¹â€ï¼Œæœ¬æ–‡é‡ç‚¹åœ¨ JS ç”Ÿæ€çš„å®è·µã€‚

å½“ä¸šåŠ¡ç³»ç»Ÿä¸å¤æ‚æ—¶ï¼Œé€šå¸¸åªç”¨ä¸€ä¸ªä»“åº“ç®¡ç†é¡¹ç›®ï¼Œé¡¹ç›®ä¸ºå•ä½“æ¶æ„ï¼ˆMonolithicï¼‰ï¼Œä¾èµ–å’Œå·¥ä½œæµéƒ½æ˜¯ç»Ÿä¸€çš„ã€‚éšç€ä¸šåŠ¡å¤æ‚åº¦çš„æå‡ï¼Œé¡¹ç›®çš„å¤æ‚æ€§ä¼šå·¨å¹…å¢é•¿ï¼Œç”±æ­¤å¯¼è‡´äº†ä¸€ç³»åˆ—é—®é¢˜ï¼šæ¯”å¦‚æŠ€æœ¯å€ºåŠ¡è¶Šç§¯è¶Šå¤šã€éƒ¨ç½²æ•ˆç‡/é¢‘ç‡ä½ã€æ‰©å±•å—é™ç­‰ç­‰ã€‚æ­¤æ—¶å°±éœ€è¦ä¸šåŠ¡å’Œæ¨¡å—çš„æ‹†åˆ†ï¼Œæ¯”å¦‚ä»è½¯ä»¶æ¶æ„å±‚é¢æå‡ºäº†å¾®æœåŠ¡æ¶æ„ï¼ˆMicroservicesï¼‰ï¼Œè€Œåœ¨ä»£ç ç®¡ç†ä¸Šé€šå¸¸ä¼šä½¿ç”¨å¤šä¸ªä»“åº“ï¼Œæ¯ä¸ªä»“åº“éƒ½ç‹¬ç«‹è¿›è¡Œå„æ¨¡å—çš„ç¼–ç ã€æµ‹è¯•å’Œå‘ç‰ˆç­‰ã€‚è¿™ç§æ–¹å¼è™½ç„¶åœ¨ä¸šåŠ¡é€»è¾‘ä¸Šè§£è€¦äº†ï¼Œä½†å´å¢åŠ äº†é¡¹ç›®çš„å·¥ç¨‹ç®¡ç†éš¾åº¦ï¼Œæ¯”å¦‚ï¼š

1. ä»£ç å’Œé…ç½®å¾ˆéš¾å…±äº«ï¼šæ¯ä¸ªä»“åº“éƒ½éœ€è¦åšä¸€äº›é‡å¤çš„å·¥ç¨‹åŒ–èƒ½åŠ›é…ç½®ï¼ˆå¦‚ eslint/test/ci ç­‰ï¼‰ä¸”æ— æ³•ç»Ÿä¸€ç»´æŠ¤
2. ä¾èµ–æ²»ç†å¤æ‚ï¼šå‡è®¾æœ‰å¤šä¸ªå·¥ç¨‹ä¾èµ– libï¼Œæ¯ä¸ªå·¥ç¨‹éƒ½ä¼šé‡å¤å®‰è£… libï¼›å¦å¤–ï¼Œå½“ lib å‡çº§æ—¶ï¼Œéœ€è¦å¯¹æ‰€æœ‰å·¥ç¨‹æ‰‹åŠ¨å‡çº§ï¼Œè¿™ç‚¹å¾ˆéš¾åšåˆ°ï¼Œæ‰€ä»¥å¾€å¾€å„å·¥ç¨‹çš„ä¾èµ–ç‰ˆæœ¬å¹¶ä¸ä¸€è‡´ï¼Œç”±æ­¤ç»å¸¸å¼•å‘ä¸€äº›è°ƒè¯•å’Œç»´æŠ¤é—®é¢˜

å¤§ä»“ç®¡ç†æ­£å¥½è§£å†³äº†è¿™äº›é—®é¢˜ï¼šæ‰€æœ‰åŒ…çš„ä¾èµ–ç»Ÿä¸€äº¤ç”±é¡¶å±‚ node_modulesï¼Œå…·å¤‡ç»Ÿä¸€çš„å·¥ä½œæµï¼Œå…±äº«åŸºç¡€çš„åº“å’Œå·¥ç¨‹åŒ–é…ç½®ç­‰ã€‚

## å¤§ä»“èƒ½åŠ›å’Œå·¥å…·é“¾

ä¸ºäº†æ›´å¥½åœ°å®ç°å¤§ä»“ç®¡ç†ï¼Œéœ€è¦é…åˆä½¿ç”¨ç›¸å…³çš„å·¥å…·ã€‚å¤§ä»“ç®¡ç†å·¥å…·åº”è¯¥è‡³å°‘å…·å¤‡ä»¥ä¸‹ä¸¤å¤§èƒ½åŠ›ï¼š

1. **ä¾èµ–ç®¡ç†**ï¼šå¯ç®¡ç†æ‰€æœ‰ package çš„ä¾èµ–å’Œå½¼æ­¤ä¹‹é—´çš„å…³è”ï¼Œå¹¶å°†å®‰è£…çš„ä¾èµ–æå‡åˆ°é¡¶å±‚ node_modules
2. **æ›´ç²¾å‡†çš„æ‰§è¡Œå’Œå‘å¸ƒæ§åˆ¶**ï¼šèƒ½å¤Ÿè¿›è¡Œç‹¬ç«‹æˆ–ç»Ÿä¸€çš„æµ‹è¯•ã€æ„å»ºå’Œç²¾å‡†å‘å¸ƒç­‰

å¦‚æœæ²¡æœ‰è¿™ä¸¤ä¸ªèƒ½åŠ›ï¼Œé‚£å¤§ä»“å°±ç›¸å½“äºæŠŠå„ä¸ªé¡¹ç›®ç”¨ä¸€ä¸ªç›®å½•ç®¡ç†äº†èµ·æ¥ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆå®é™…ç”¨å¤„ã€‚åœ¨ Node ç”Ÿæ€ä¸­ï¼Œä¸»è¦æœ‰ NPM/Yarn ä¸¤ç§åŒ…ç®¡ç†å™¨ï¼Œä¸¤è€…éƒ½å¯ä»¥é€šè¿‡å¼€å¯ Workspace ç‰¹æ€§æ¥æ”¯æŒèƒ½åŠ› 1 å¹¶å¯¹èƒ½åŠ› 2 æä¾›éƒ¨åˆ†æ”¯æŒã€‚[Lerna](https://github.com/lerna/lerna) å’Œ [Bolt](https://github.com/boltpkg/bolt) ç­‰å·¥å…·å¯¹èƒ½åŠ› 2 çš„æ”¯æŒè¾ƒå¥½ï¼Œç»¼åˆä¸¤è€…åœ¨ Github çš„æ´»è·ƒåº¦å’Œç”¨é‡ï¼Œæœ¬æ–‡é€‰æ‹© Lernaï¼ˆä¸»è¦æ˜¯ Bolt æˆ‘ä¹Ÿæ²¡ç”¨è¿‡ ğŸ™ƒï¼‰ã€‚ä½¿ç”¨ Lerna çš„å¼€æºé¡¹ç›®æœ‰ï¼š[jest](https://github.com/facebook/jest)ã€[create-react-app](https://github.com/facebook/create-react-app)ã€[webpack-cli](https://github.com/webpack/webpack-cli)...æœ€åï¼Œæ€»çš„æ–¹æ¡ˆæœ‰ä»¥ä¸‹ 4 ç§ï¼š

- æ–¹æ¡ˆ 1ï¼šLerna + NPM
- æ–¹æ¡ˆ 2ï¼šLerna + Yarn
- æ–¹æ¡ˆ 3ï¼šLerna + NPM Workspace
- æ–¹æ¡ˆ 4ï¼šLerna + Yarn Workspace

## æ–¹æ¡ˆå¯¹æ¯”

### è¿è¡Œå’Œæµ‹è¯•ç¯å¢ƒ

åé¢æ€§èƒ½å¯¹æ¯”éƒ¨åˆ†æˆ‘ä»¬ä¸»è¦çœ‹ä¸‹ä¾èµ–çš„å®‰è£…è€—æ—¶ï¼Œé¦–å…ˆè¯´æ˜ä¸‹æµ‹è¯•æ¡ä»¶ï¼š

- ç‰ˆæœ¬å·ï¼šlerna@4.0.0ã€npm@8.1.2ã€yarn@1.22.17
- ç³»ç»Ÿï¼šDevCloud å¼€å‘å®¹å™¨ tlinux-2.2ã€CPUï¼š8 æ ¸ï¼ˆå‹å·æœªçŸ¥ï¼‰ã€RAM/ROMï¼š16G/200G
- æ¯æ¬¡æµ‹è¯•å‰å‡åˆ é™¤ node_modulesã€package-lock.jsonã€yarn.locakï¼Œä½¿ç”¨`npm cache clean --force`å’Œ`yarn clean`æ¸…ç©ºç¼“å­˜
- ä½¿ç”¨ [gnomon](https://www.npmjs.com/package/gnomon) ç»Ÿè®¡æ—¶é—´ï¼Œå¦‚ï¼š`lerna bootstrap | gnomon`ï¼Œæ¯ä¸ªæ–¹æ¡ˆæµ‹è¯•ä¸‰æ¬¡

### Lerna + NPM

ä½¿ç”¨`lerna init`å¿«é€Ÿåˆ›å»ºä¸€ä¸ª Lerna å·¥ç¨‹ï¼š

```bash
mkdir mono-repo && cd $_
lerna init
```

æ¥ä¸‹æ¥ç”¨`lerna create`åœ¨ packages ä¸‹é¢æ·»åŠ ä¸¤ä¸ªåŒ…ï¼š

```bash
lerna create pkgA -y
lerna create pkgB -y
```

Lerna å¹¶ä¸ä¼šåˆå§‹åŒ– git ä»“åº“ä¿¡æ¯ï¼Œæ‰€ä»¥éœ€è¦æ‰§è¡Œ`git init`ï¼Œå¹¶æ·»åŠ ä¸€ä¸ª .gitignore æ–‡ä»¶ï¼Œå°† node_modules å¿½ç•¥ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

```bash
mono-repo
â”œâ”€â”€ .gitignore
â”œâ”€â”€ lerna.json
â”œâ”€â”€ package.json
â””â”€â”€ packages
    â”œâ”€â”€ pkgA
    â”‚   â””â”€â”€ package.json
    â””â”€â”€ pkgB
        â””â”€â”€ package.json
```

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸‹ Lerna åœ¨å¤§ä»“ä¸Šçš„èƒ½åŠ›ä½“ç°ã€‚

- ä¾èµ–åˆå§‹åŒ–å’Œæå‡ï¼š`lerna bootstrap`

è¯¥å‘½ä»¤ä¼šæ‰§è¡Œç±»ä¼¼`npm install`çš„åŠŸèƒ½ï¼Œä¸è¿‡ Lerna ä¼šä¸€æ¬¡æ€§å®‰è£…æ‰€æœ‰åŒ…çš„æ‰€æœ‰ä¾èµ–ï¼Œé»˜è®¤å°†ä¾èµ–å®‰è£…åœ¨å„ä¸ªåŒ…çš„ node_modules ä¸‹ï¼Œå¹¶ä¸ä¼šå°†å…±åŒçš„ä¾èµ–æå‡åˆ°é¡¶å±‚ node_modulesï¼Œå¯ä»¥é€šè¿‡æ·»åŠ `--hoist`æ¥åšåˆ°ï¼š`lerna bootstrap --hoist`ã€‚

![](https://techblog-1253540739.cos.ap-chengdu.myqcloud.com/lerna-hoist.jpg)

æ¯æ¬¡éƒ½åŠ ä¸Š`â€”-hoist`ä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œå¯ä»¥é…ç½® lerna.json çš„ bootstrap é€‰é¡¹é»˜è®¤æ‰§è¡Œæå‡ï¼š

```json
{
  "packages": ["packages/*"],
  "command": {
    "bootstrap": {
      "hoist": true
    }
  },
  "version": "0.0.1"
}
```

**Lerna åˆ¤æ–­ç‰ˆæœ¬å·çš„å­—ç¬¦ä¸²ä¸€æ¨¡ä¸€æ ·æ—¶æ‰è®¤ä¸ºæ˜¯åŒæ ·çš„ä¾èµ–ï¼Œå¹¶ä¸æ˜¯ç‰¹åˆ«çš„æ™ºèƒ½**ï¼ˆåé¢ä»‹ç»çš„ Yarn Workspace æ˜¯æ ¹æ®è¯­ä¹‰ç‰ˆæœ¬åˆ¤æ–­ï¼Œæ— æ­¤é—®é¢˜ï¼‰ã€‚æ¯”å¦‚ pkgA ä¾èµ–çš„ lodash æ˜¯ 4.17.21ï¼ŒpkgB ä¾èµ–çš„æ˜¯ ^4.17.21ï¼Œlerna è®¤ä¸ºè¿™æ˜¯ä¸¤ä¸ªç‰ˆæœ¬ï¼Œæ‰€ä»¥ä»ç„¶ä¼šä¿ç•™ pkgB çš„ node_modules å’Œ package-lock.json...

![](https://techblog-1253540739.cos.ap-chengdu.myqcloud.com/lerna-hoist-version-judge.jpg)

- å®‰è£…ä¾èµ–

å¦‚æœåˆ‡æ¢åˆ°æŸä¸ªåŒ…ä¸‹ï¼Œç”¨`npm install xxx`å®‰è£…ä¾èµ–ï¼Œåˆ™ä¼šå®‰è£…åœ¨å½“å‰ç›®å½•çš„ node_module ä¸‹ï¼Œå¤§ä»“çš„ä¾èµ–ç®¡ç†èƒ½åŠ›ä¼šå¤±æ•ˆã€‚Lerna æä¾›äº† add æŒ‡ä»¤ï¼š

```bash
# ç»™æ‰€æœ‰åŒ…å®‰è£… xxx ä¾èµ–
lerna add xxx
# ç»™ pkgA åŒ…å®‰è£… xxx ä¾èµ–
lerna add xxx --scope=pkgA
```

å®‰è£…æ—¶ä¹Ÿæ”¯æŒæ·»åŠ å‚æ•°`-D`(â€”dev devDependencies å¼€å‘ä¾èµ–) å’Œ`-E`(â€”exact ç²¾ç¡®ç‰ˆæœ¬)ã€‚**ä½† Lerna çš„ add å‘½ä»¤æ¯æ¬¡åªèƒ½å®‰è£…ä¸€ä¸ªä¾èµ–ï¼Œä¸èƒ½åƒ npm install å’Œ yarn add ä¸€æ¬¡å¯è£…å¤šä¸ªä¾èµ–**ã€‚

- ç§»é™¤ä¾èµ–

Lerna å¹¶æœªæä¾›ç›¸å…³çš„æŒ‡ä»¤ï¼Œåªèƒ½æ‰‹åŠ¨ç¼–è¾‘è¯¥åŒ…çš„ package.jsonï¼Œæ‰‹åŠ¨ç§»é™¤å¯¹åº”çš„ä¾èµ–é¡¹ï¼Œæœ€åå†è¿è¡Œ`lerna bootstrap`æŒ‡ä»¤æ›´æ–°ä¾èµ–ã€‚

å…¶ä»–çš„ä¸€äº›æŒ‡ä»¤å¤§å®¶å¯è‡ªè¡Œä½“éªŒï¼Œå¦‚ï¼š`lerna clean`ï¼šåˆ é™¤æ‰€æœ‰åŒ…çš„ node_modulesã€`lerna list`ï¼šåˆ—å‡ºæ‰€æœ‰çš„åŒ…ã€‚

ä»¥ä¸Šä¸‰é¡¹ï¼šä¾èµ–åˆå§‹åŒ–å’Œæå‡ã€å®‰è£…ä¾èµ–ã€ç§»é™¤ä¾èµ–æ˜¯å¤§ä»“ä¾èµ–ç®¡ç†çš„åŸºæœ¬èƒ½åŠ›ï¼ŒLerna åšåˆ°äº†ä¸åŒç¨‹åº¦çš„æ”¯æŒã€‚Lerna ä¹Ÿæä¾›äº†ä¸€äº›é«˜çº§èƒ½åŠ›ï¼š

- ç»Ÿä¸€/å…¨å±€æ‰§è¡ŒåŒ…çš„ scripts è„šæœ¬ï¼š

`lerna run <script> -- [..args]`

```bash
# æ‰§è¡Œæ‰€æœ‰åŒ…çš„æµ‹è¯•æŒ‡ä»¤
lerna run test
# æ‰§è¡Œæ‰€æœ‰åŒ…çš„æ„å»ºæŒ‡ä»¤
lerna run build
# æ‰§è¡Œ pkgA åŒ…çš„ xxx æŒ‡ä»¤
lerna run xxx --scope=pkgA
```

- åœ¨å„ä¸ªåŒ…ä¸‹æ‰§è¡Œç»Ÿä¸€çš„å‘½ä»¤ï¼š

`lerna exec -- <command> [..args]`

æ¯”å¦‚åœ¨å„ä¸ªåŒ…ä¸‹æ‰§è¡Œ`rm -rf dist/`æ¥åˆ é™¤å„ä¸ªåŒ…ä¸‹çš„ dist ç›®å½•ï¼š

```bash
# åœ¨æ‰€æœ‰åŒ…ä¸‹æ‰§è¡Œ rm -rf dist/
lerna exec -- rm -rf dist/
# åœ¨ pkgA ä¸‹æ‰§è¡Œ rm -rf dist/
lerna exec -- rm -rf dist --scope=pkgA
```

- ç»Ÿä¸€çš„å‘å¸ƒï¼š`lerna publish`

Lerna æ”¯æŒä¸¤ç§ç‰ˆæœ¬å‘å¸ƒæ¨¡å¼ï¼Œé»˜è®¤ä¸ºå›ºå®šæ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰åŒ…çš„ç‰ˆæœ¬å·ä¼šè·Ÿéš lerna.json - version å­—æ®µä¸­å®šä¹‰çš„ç‰ˆæœ¬å·ã€‚å°† version çš„å€¼æ›´æ”¹ä¸º independent åï¼Œå°±å˜æˆäº†ç‹¬ç«‹æ¨¡å¼ï¼Œæ­¤æ—¶å¯¹äºå˜æ›´çš„åŒ…ï¼ŒLerna ä¼šè®©å¼€å‘è€…å†³å®šæ¯ä¸ªåŒ…æ˜¯è¯­ä¹‰ç‰ˆæœ¬ä¸­çš„å“ªç§å˜æ›´ï¼špatchã€minor è¿˜æ˜¯ majorã€‚

![](https://techblog-1253540739.cos.ap-chengdu.myqcloud.com/publish-version.jpg)

```json
{
  "packages": ["packages/*"],
  // "version": "0.0.1"
  "version": "independent" // ç‹¬ç«‹æ¨¡å¼
}
```

å¦å¤–é€šå¸¸å‘å¸ƒè¿˜ä¼´éšç€ changelog ç”Ÿæˆã€æ·»åŠ å‘å¸ƒ commitã€åˆ›å»ºå‘å¸ƒ tag ç­‰æ“ä½œï¼Œè¿™äº›éƒ½å¯ä»¥é€šè¿‡ lerna.json ç²¾ç»†æ§åˆ¶ã€‚æ¯”å¦‚è®¾ç½®å‘å¸ƒæºå’Œå‘å¸ƒæ—¶çš„ git æäº¤ä¿¡æ¯ï¼š

```json
{
  "version": "0.0.1",
  "command": {
    "publish": {
      "ignoreChanges": ["ignored-file", "*.md"],
      "message": "chore(release): publish",
      "registry": "https://mirrors.tencent.com/npm/"
    }
  },
  "packages": ["packages/*"]
}
```

| å‘½ä»¤            | ç¬¬ä¸€æ¬¡   | ç¬¬äºŒæ¬¡   | ç¬¬ä¸‰æ¬¡   |
| :-------------- | :------- | :------- | :------- |
| lerna bootstrap | 65.6626s | 61.8620s | 62.9221s |

### Lerna + Yarn

è¿™ç§æ–¹æ¡ˆå…¶å®å¹¶ä¸èƒ½å®ç°ï¼Œå› ä¸ºåœ¨ lerna.json ä¸­å°† npmClient å­—æ®µè®¾ç½®ä¸º yarn åï¼š

```json
{
  "packages": ["packages/*"],
  "command": {
    "bootstrap": {
      "hoist": true
    }
  },
  "version": "0.0.1",
  "npmClient": "yarn"
}
```

è¿è¡Œ`lerna bootstrap`ä¼šä¸ Yarn å†²çªï¼Œæç¤ºæ˜¯ç›´æ¥ä½¿ç”¨ Yarn Workspaceï¼š

```bash
âœ  lerna bootstrap
lerna notice cli v4.0.0
lerna ERR! EWORKSPACES --hoist is not supported with --npm-client=yarn, use yarn workspaces instead
lerna ERR! EWORKSPACES A guide is available at https://yarnpkg.com/blog/2017/08/02/introducing-workspaces/
```

### Lerna + Yarn Workspace

é¦–å…ˆé…ç½® Lerna ä½¿ç”¨ Yarn å¹¶å¯ç”¨ workspacesï¼š

```bash
{
  "npmClient": "yarn",
  "useWorkspaces": "true",
}
```

ç„¶ååœ¨æ ¹ç›®å½•çš„ package.json ä¸­é…ç½® workspacesï¼Œæ­¤æ—¶ lerna.json ä¸­çš„ packages è®¾ç½®ä¼šå¤±æ•ˆï¼š

```bash
{
  "name": "root",
  "workspaces": [
    "packages/*"
  ],
}
```

è¿™æ ·å°±ç›¸å½“äºä¾èµ–ç®¡ç†å…¨éƒ¨äº¤ç”± Yarn æ¥ç®¡ç†äº†ï¼š

- ä¾èµ–åˆå§‹åŒ–å’Œæå‡ï¼š`yarn`
- å®‰è£…ä¾èµ–ï¼Œæ¯”å¦‚ç»™ pkgA å®‰è£…ä¾èµ–ï¼š`yarn workspace pkgA add xxx`ã€‚ä¸åŒäº`lerna add`ï¼ŒYarn å°±æ˜¯æ­£å¸¸çš„åŒ…ç®¡ç†å™¨ï¼Œå¯ä»¥ä¸€æ¬¡è£…å¤šä¸ªä¾èµ–
- ç§»é™¤ä¾èµ–ï¼Œæ¯”å¦‚ç§»é™¤ pkgA åŒ…çš„ xxx ä¾èµ–`yarn workspace pkgA remove xxx`

Yarn Workspace ä¹Ÿæä¾›äº†ä¸€äº›å…¨å±€å’Œç»Ÿä¸€çš„æ‰§è¡Œèƒ½åŠ›ï¼Œæ¯”å¦‚ï¼š

```bash
# æ‰§è¡Œ pkgA çš„ scripts è„šæœ¬å‘½ä»¤
yarn workspace pkgA test
yarn workspace pkgA build
yarn workspace pkgA publish
yarn workspace pkgA xxx
```

```bash
# æ‰§è¡Œæ‰€æœ‰åŒ…çš„æµ‹è¯•æŒ‡ä»¤
yarn workspaces run test
# æ‰§è¡Œæ‰€æœ‰åŒ…çš„ xxx æŒ‡ä»¤ï¼ˆpackage.json - scriptsï¼‰
yarn workspaces run xxx
```

å¯ä»¥çœ‹åˆ°ï¼Œ**Yarn æ— æ³•ç›´æ¥åšåˆ°`lerna publish`/lerna.json çš„æ›´ç²¾å‡†æ§åˆ¶èƒ½åŠ›**ã€‚

| å‘½ä»¤ | ç¬¬ä¸€æ¬¡   | ç¬¬äºŒæ¬¡   | ç¬¬ä¸‰æ¬¡   |
| :--- | :------- | :------- | :------- |
| yarn | 51.9236s | 59.0584s | 58.1938s |

### Lerna + NPM Workspace

NPM åœ¨ 7.x åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ä¹Ÿæ”¯æŒäº† Workspace ç‰¹æ€§ï¼š[https://docs.npmjs.com/cli/v7/using-npm/workspaces](https://docs.npmjs.com/cli/v7/using-npm/workspaces)ã€‚èƒ½åŠ›ä¸ Yarn Workspace åŸºæœ¬ç±»ä¼¼ï¼Œåªæ˜¯è¯­æ³•ä¸åŒï¼ŒåŒæ ·å…ˆæ›´æ”¹ lerna.json å¼€å¯ workspacesï¼š

```bash
{
  "useWorkspaces": "true",
}
```

ç„¶ååœ¨æ ¹ç›®å½•çš„ package.json ä¸­é…ç½® workspacesï¼š

```bash
{
  "name": "root",
  "workspaces": [
    "packages/*"
  ],
}
```

- ä¾èµ–åˆå§‹åŒ–å’Œæå‡ï¼š`npm install`
- å®‰è£…ä¾èµ–ï¼Œæ¯”å¦‚ç»™ pkgA å®‰è£…ä¾èµ–ï¼š`npm install xxx -w pkgA`
- ç§»é™¤ä¾èµ–ï¼Œæ¯”å¦‚ç§»é™¤ pkgA åŒ…çš„ xxx ä¾èµ–ï¼š`npm uninstall xxx -w pkgA`

åŒæ · NPM Workspace æä¾›äº†ä¸€äº›ç»Ÿä¸€å’Œå…¨å±€çš„æ‰§è¡Œèƒ½åŠ›ï¼š

```bash
# æ‰§è¡Œ pkgA çš„ scripts è„šæœ¬å‘½ä»¤
npm run test -w a
npm run xxx -w a

# æ‰§è¡Œå…¨éƒ¨åŒ…çš„ scripts è„šæœ¬å‘½ä»¤
npm run test --workspaces
```

| å‘½ä»¤        | ç¬¬ä¸€æ¬¡   | ç¬¬äºŒæ¬¡   | ç¬¬ä¸‰æ¬¡   |
| :---------- | :------- | :------- | :------- |
| npm install | 72.9516s | 83.0750s | 86.5041s |

## ç»“è®º

| å‘½ä»¤                   | èƒ½åŠ›                                      | Lerna(NPM)                                                  | NPM Workspace                                              | Yarn Workspace                                                                                |
| :--------------------- | :---------------------------------------- | :---------------------------------------------------------- | :--------------------------------------------------------- | :-------------------------------------------------------------------------------------------- |
| ä¾èµ–ç®¡ç†               | ä¾èµ–åˆå§‹åŒ–å’Œæå‡                          | `lerna bootstrap`                                           | `npm install`                                              | `yarn`                                                                                        |
|                        | å®‰è£…ä¾èµ–                                  | `lerna add xxx --scope=pkg`                                 | `npm install xxx -w pkg`                                   | `yarn workspace pkg add xxx`                                                                  |
|                        | ç§»é™¤ä¾èµ–                                  | æ—                                                           | `npm uninstall xxx -w pkg`                                 | `yarn workspace pkg remove xxx`                                                               |
| æ›´ç²¾å‡†çš„æ‰§è¡Œå’Œå‘å¸ƒæ§åˆ¶ | å…¨å±€æ‰§è¡Œ scipts æŒ‡ä»¤                      | `lerna run xxx --scope=pkg`                                 | `npm run xxx -w pkg`                                       | `yarn workspace pkg run xxx`                                                                  |
|                        | ç»Ÿä¸€æ‰§è¡Œ scipts æŒ‡ä»¤                      | `lerna run xxx`                                             | `npm run xxx --ws`                                         | `yarn workspaces run xxx`                                                                     |
|                        | åœ¨æ¯ä¸ªåŒ…ä¸‹åŠ¨æ€æ‰§è¡ŒæŒ‡ä»¤                    | `lerna exec -- command`                                     | `npm exec -c 'command' --ws`                               | `yarn workspaces foreach command`ï¼ˆ[éœ€æ’ä»¶æ”¯æŒ](https://yarnpkg.com/cli/workspaces/foreach)ï¼‰ |
|                        | ç»Ÿä¸€å‘å¸ƒé…ç½®ã€changelogã€tag å’Œ commit ç­‰ | lerna.json/`lerna publish`                                  | æ—                                                          | æ—                                                                                             |
| ä¾èµ–åˆå§‹åŒ–è€—æ—¶         | /                                         | 65.6626sã€61.8620sã€62.9221s                                | 72.9516sã€83.0750sã€86.5041s                               | 51.9236sã€59.0584sã€58.1938s                                                                  |
| ç›¸å¯¹ç¼ºç‚¹               | /                                         | 1. æ— æ³•ä¸€æ¬¡å®‰è£…å¤šä¸ªä¾èµ–<br>2. æœªæä¾›ä¾èµ–ç§»é™¤èƒ½åŠ› | 1. æœªæä¾›æ›´ä¸ºç²¾ç»†çš„å‘å¸ƒæ§åˆ¶é…ç½®<br>2. ä¾èµ–å®‰è£…è€—æ—¶ç›¸å¯¹è¾ƒé•¿ | 1. æœªæä¾›æ›´ä¸ºç²¾ç»†çš„å‘å¸ƒæ§åˆ¶é…ç½®<br>2. ä¸åŸç”Ÿæ”¯æŒåœ¨æ¯ä¸ªåŒ…ä¸‹åŠ¨æ€æ‰§è¡ŒæŒ‡ä»¤                        |

ç»¼ä¸Šï¼Œåªä½¿ç”¨ Lerna å’Œåªä½¿ç”¨ Yarn/NPM Workspace éƒ½èƒ½å®Œæˆå¤§éƒ¨åˆ†å¤§ä»“çš„ç®¡ç†èƒ½åŠ›ï¼Œå‰è€…çš„ä¾èµ–ç®¡ç†å¼±ä¸€äº›ï¼Œåè€…çš„å‘å¸ƒæ§åˆ¶å¼±ä¸€äº›ã€‚ä»å·¥ä½œæµçš„å®Œæ•´åº¦ä¸Šçœ‹ï¼ŒLerna ä¼šæ›´å…¨é¢ï¼Œä¸è¿‡ä¹Ÿæœ‰åƒ[babel/babel](https://github.com/babel/babel/blob/main/doc/design/monorepo.md)è¿™ç§åªä½¿ç”¨äº† Yarn Workspaceï¼Œç„¶åå†é¢å¤–å¼€å‘ä¸€äº›æ’ä»¶çš„ç”¨æ³•ã€‚**å½“ç„¶æ—¥å¸¸æœ€ä½³å®è·µå°±æ˜¯å°†ä¸¤è€…ç»“åˆï¼Œä¾èµ–ç®¡ç†/æµ‹è¯•/æ„å»ºç­‰ç»Ÿä¸€äº¤ç”± Workspace å¤„ç†ï¼Œå‘å¸ƒç»Ÿä¸€ç”¨ Lernaã€‚**è‡³äº NPM å’Œ Yarn çš„é€‰æ‹©ï¼Œå°±æ˜¯å¦ä¸€ä¸ªè¯é¢˜äº†ï¼ŒYarn ç¨å¿«ï¼Œä½†é€‰æ‹©é€šå¸¸çœ‹ä¸ªäººé£æ ¼ï¼Œæˆ‘ä¼šæ›´åŠ å€¾å‘äº NPMã€‚è‡³äºå¤§ä»“ä¸‹çš„å·¥ç¨‹åŒ–èƒ½åŠ›æ­å»ºå’Œæœ€ä½³å®è·µï¼Œæˆ‘ä»¬ä¸‹ä¸ªè¯é¢˜è§ï½

## å‚è€ƒ

- [Why Lerna and Yarn Workspaces is a Perfect Match for Building Mono-Repos](https://doppelmutzi.github.io/monorepo-lerna-yarn-workspaces/)
